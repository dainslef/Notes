<!-- TOC -->

- [Git 配置](#git-配置)
	- [配置文件](#配置文件)
	- [Unicode編碼問題](#unicode編碼問題)
	- [文件權限](#文件權限)
- [版本操作](#版本操作)
	- [創建版本庫](#創建版本庫)
	- [提交改動](#提交改動)
	- [重命名版本庫中的文件](#重命名版本庫中的文件)
	- [修改歷史提交](#修改歷史提交)
	- [忽略工作目錄中特定文件](#忽略工作目錄中特定文件)
	- [查看/比較提交](#查看比較提交)
	- [提交管理](#提交管理)
	- [標籤管理](#標籤管理)
	- [查看文件改動](#查看文件改動)
	- [分支管理](#分支管理)
		- [切換分支](#切換分支)
		- [合併分支](#合併分支)
		- [其它分支文件](#其它分支文件)
	- [暫存變更 (stash)](#暫存變更-stash)
- [遠程倉庫](#遠程倉庫)
	- [拷貝遠程倉庫](#拷貝遠程倉庫)
	- [管理遠程倉庫](#管理遠程倉庫)
	- [管理遠程分支](#管理遠程分支)
		- [分支合併規則](#分支合併規則)
		- [創建/刪除遠程分支](#創建刪除遠程分支)
		- [強制覆蓋遠程分支內容](#強制覆蓋遠程分支內容)
- [GitHub 配置](#github-配置)
	- [創建 GitHub 倉庫](#創建-github-倉庫)
	- [生成 SSH 本地密鑰](#生成-ssh-本地密鑰)
	- [推送本地分支](#推送本地分支)
	- [關於提交者](#關於提交者)
- [清理提交](#清理提交)

<!-- /TOC -->



# Git 配置
在使用Git之前，首先要設置用戶的**全局用戶名**和**郵箱**，做爲代碼提交者的身份標識。

```
$ git config --global user.name [用戶名]
$ git config --global user.email [郵箱]
```

設置Git的默認編輯器：

```
$ git config --global core.editor [編輯器名稱]
```

設置Git的遠程推送方式：

```
$ git config --global push.default [推送選項]
```

**推送選項**在`Git 2.0`之後默認爲`simple`，之前爲`matching`。
推送選項取值含義：

- `current`、`simple` 推送當前分支到遠程關聯的同名分支。
- `matching` 推送與遠程倉庫具有的分支中所有與本地倉庫分支同名的本地分支。

設置Git換行符處理方式：

```
$ git config --global core.autocrlf [換行符處理方式]
```

**換行符選項**取值含義：

- `true`

	在Windows提交到Unix環境時使用。
	提交時將`CRLF`轉換爲`LF`，而簽出代碼時自動將`LF`轉換爲`CRLF`。

- `input`

	在Unix環境中使用。
	提交時`CRLF`換行符轉換爲`LF`，而簽出代碼時`LF`不轉換爲`CRLF`。

- `false`

	在Windows環境中使用，不轉換`CRLF`，直接提交。

## 配置文件
Git配置文件分爲**全局配置文件**和**倉庫配置文件**。

- 倉庫配置文件：

	倉庫配置文件路徑爲`[倉庫路徑]/.git/config`，使用`git config`指令會將配置寫入此文件。

- 全局配置文件：

	全局配置文件路徑爲`~/.gitconfig`。

	- 在`Linux/*BSD`中，家目錄爲`/home/[用戶名]`。
	- 在`macOS`中，家目錄爲`/Users/[用戶名]`。
	- 在`Windows`中，家目錄爲爲`C:\Users\[用戶名]`。

	使用`git config --global`指令會將配置寫入此文件中。
	全局配置的優先級**低於**當前倉庫的配置，當前倉庫的配置與全局配置不一致時會**覆蓋**全局配置。

## Unicode編碼問題
使用`Git for Windows`時，需要配置`LC_ALL`環境變量(如`en_US.UTF-8/zh_TW.UTF-8`等)，
否則輸出中文相關信息時會出現Unicode編碼而非正常輸出漢字。

如下所示：

```
<XX><XX><XX>...
```

## 文件權限
默認Git會追蹤文件的權限變化，若不需要監控權限變化可執行如下指令：

```
$ git config core.filemode false
```

亦可在配置中關閉：

```ini
[core]
	filemode = false
```

使用git status查看查看當前工作區的文件變化時，
添加-v參數，可在末尾增加文件的權限變化，示例：

```
$ git status -v
On branch dev
...
diff --git a/tools/mode_change.sh b/tools/mode_change.sh
old mode 100644
new mode 100755
```

查看指定倉庫路徑下的文件權限：

```
$ git ls-files -s [file/dir]
$ git ls-files --stage [file/dir]
```

示例：

```html
$ git ls-files -s ./shell
100644 d557ad0a566b104265381e3f5645825c31bc40bb 0       shell/.bashrc
100644 d6584ba60c81b0da76889ffd76f5921e98afb4fc 0       shell/.zshrc
100644 76881fbd378ddb8027d583ea64d3f9bc9c940da2 0       shell/ConEmu.xml
100644 1ed617a2301fd59d6a2cc403db73d8482d3875bf 0       shell/config.fish
```

使用git update-index指令可直接修改倉庫中的文件權限：

```html
<!-- 直接修改git倉庫中的權限，不會影響當前實際文件的權限 -->
$ git update-index --chmod=[permission] [file/dir]
```

示例：

```html
<!-- 支持chmod指令的語法 -->
$ git update-index --chmod=755 xxx_file
$ git update-index --chmod=+x xxx_file
```



# 版本操作
如同其它版本控制工具一樣，使用Git能夠方便地進行版本的**提交**、**回滾**、**比較**等操作。

## 創建版本庫
選擇一個可用的空目錄作爲源碼倉庫，執行指令將此目錄初始化爲版本庫：

```
$ git init
```

指令成功指令後目錄下會多出一個名爲`.git`的目錄，該目錄記錄了版本庫的各種信息，不要隨意修改。

## 提交改動
向版本庫提交改動需要以下幾個步驟：

1. 添加有改動的文件：

	```
	$ git add [文件路徑]
	```

1. 執行提交操作：

	```
	$ git commit
	```

如果進行了錯誤的操作，在提交之前，可以放棄緩衝區的更改：

```
$ git reset
```

在提交時可一同添加提交說明，使用：

```
$ git commit -m [提交說明]
```

如果需要修改提交說明，使用命令修改最近一次的提交說明：

```
$ git commit --amend
```

還可以修改最近一次的提交者信息：

```
$ git commit --amend --author="用戶名 <郵箱>"
```

## 重命名版本庫中的文件
版本庫中的文件**不能**直接使用Unix的`rm`、`mv`等命令進行操作。
使用`mv`重命名文件後，Git會認爲原文件在版本庫中被**刪除**了，
原文件的在版本庫內的記錄不會繼續到重命名後的新文件上。

在版本庫內重命名文件應使用Git提供的指令：

```
$ git mv [源文件名] [新文件名]
```

## 修改歷史提交
要修改歷史版本的提交，首先要重構目標提交所在的提交的前一次提交。

修改歷史提交，需要執行以下步驟：

1. 執行`git rebase -i [commit_id]`，之後會進入交互式的歷史提交查看頁面，
在此頁面將要修改的提交說明前的`pack`字段改爲`edit`(若僅需修改歷史提交說明，則修改爲`reword`)，
可設置多個需要編輯的提交。
1. 字段修改完畢後，Git會自動支跳轉到該次提交，
編輯該次提交(reword模式下，會直接跳轉到提交說明編輯頁面)。
1. 之後重新構建提交，執行`git rebase --continue`，Git會跳轉到下一個編輯的提交，
重複以上操作，直至跳轉到最近的提交。

## 忽略工作目錄中特定文件
默認配置下，Git會將工作目錄中的**所有文件**視爲目標文件，
一旦出現新增文件，便會給予提示(存在尚未跟蹤的文件)。

查看當前暫存區的狀態：

```html
$ git status

<!-- 展示詳細變化，包括文件權限變化 -->
$ git status -v
```

要想讓Git忽略某些文件，可以在工作目錄中創建`.gitignore`文件，將忽略文件的文件名分行寫入其中(一行一個文件名)：

- `.gitignore`文件內的忽略文件支持`Unix`文件名匹配規則，可以使用`*`、`?`等操作符匹配多個文件名。
- `.gitignore`文件自身也可加入到忽略列表中。

查看簡潔的文件狀態變化，使用命令：

```
$ git status -s
```

`??`符號代表未跟蹤的文件。

## 查看/比較提交
使用`git show`指令可查看提交中具體的變更內容。

查看最近提交的改動詳情：

```
$ git show
```

查看某個提交的改動詳情：

```
$ git show [commit_id/標籤名]
```

比較文件當前狀態與版本庫中的區別：

```html
<!-- 查看當前工作區與最近一次的提交版本有哪些區別 -->
$ git diff
```

比較不同版本/分支：

```c
// 將當前版本與指定commit進行比較
$ git diff [commit_id]
// 將兩個commit版本進行比較
$ git diff [commit_id1] [commit_id2]
// 將兩個分支進行比較
$ git diff [分支名1] [分支名2]
```

## 提交管理
使用`git log`查看提交歷史：

```c
// 交互式查看版本庫的歷史提交記錄和commit_id
$ git log

// 僅僅查看提交的commit_id
$ git log --pretty=oneline
```

根據每次提交的`commit_id`回滾到歷史版本：

```c
// 回滾到指定版本，該版本之後的文件改動變爲待提交狀態(僅回退索引和提交記錄，源碼保留)
$ git reset [commit_id]

// 回滾到指令版本同時完全清除該版本之後的文件變化
$ git reset --hard [commit_id]
```

回退到歷史版本之後，將不能在`git log`指令中看到自回退版本之後的`commit_id`。
若需要之後版本的`commit_id`，執行指令：

```
$ git reflog
```

## 標籤管理
使用`git tag`相關指令給歷史提交添加**標籤**：

```c
// 給最近一次提交的版本添加版本標籤(默認版本標籤說明爲空)
$ git tag [標籤名]

// 添加版本標籤同時添加標籤說明
$ git tag [標籤名] -m [版本說明]

// 給指定某次提交添加版本標籤
$ git tag [標籤名] [commit_id]

// 刪除指定標籤
$ git tag -d [要刪除的標籤名]
```

## 查看文件改動
使用`git log`指令指定文件路徑時可以查看指定文件的改動。

```c
// 查看具體某一個文件的歷史改動
$ git log [文件名]

// 查看文件改動同時顯示具體變更內容
$ git log -p [文件名]

// 同時展示文件的刪減
$ git log --summary
```

## 分支管理
Git提供了完整的分支管理功能。

使用`git branch`相關指令查看、管理分支：

```c
// 查看本地分支
$ git branch

// 查看所有分支(包括遠程分支)
$ git branch -a

// 刪除指定本地分支(未完全合併的分支不會被刪除)
$ git branch -d [分支名稱]

// 強制刪除指定分支
$ git branch -D [分支名稱]

// 刪除指定遠程分支
$ git branch -rd [遠程分支名稱]

// 重命名分支
$ git branch -m [原分支名稱] [新分支名稱]
```

使用`git branch -a`查看遠程分支時，遠程分支名稱以`remotes/`爲起始路徑。
刪除遠程分支時，應以`remotes/`之後的部分作爲分支名稱，如下所示：

```html
$ git branch -a <!-- 查看所有分支 -->
* dev
  master
  remotes/GitHub/dev
$ git bracch -rd remotes/GitHub/dev <!-- 刪除失敗，分支名稱未找到 -->
error: remote-tracking branch 'remotes/GitHub/dev' not found.
$ git branch -rd GitHub/dev <!-- 刪除遠程分支時應忽略 remotes 前綴 -->
```

### 切換分支
使用`git checkout`相關指令切換分支：

```html
<!-- 切換到指定分支 -->
$ git checkout 分支名稱

<!-- 創建分支並切換到該分支 -->
$ git checkout -b 分支名稱
```

從`Git 2.23`版本開始，引入了新的子指令`git switch`用於切換分支:

```
$ git switch 分支名稱
```

原先的checkout指令承載了過多功能，例如可使用`git checkout 提交ID`切換到任意提交，
相比之下switch僅用於分支切換，不支持類似功能。

### 合併分支
使用`git merge`合併分支：

```html
<!-- 合併某分支到當前分支 -->
$ git merge [分支名]
```

當本地分支內容與遠程分支發生衝突時，可以強制更新遠程分支到本地：

```html
<!-- 無視衝突內容，強制切換到遠程分支 -->
$ git reset --hard [遠程分支]
<!-- 拉取遠程分支的更新 -->
$ git pull
```

### 其它分支文件
使用`git show`可查看其它分支的文件：

```html
<!-- 展示對應分支名稱下根路徑的內容 -->
$ git show [分支名稱]:

<!-- 展示對應分支名稱下指定文件路徑的內容 -->
$ git show [分支名稱]:[路徑]

<!-- 展示對應分支名稱下指定文件的內容 -->
$ git show [分支名稱]:[文件路徑]
```

將其它分支的文件導入當前分支：

```html
<!-- 重定向其它分支的文件內容到當前分支的指令路徑 -->
$ git show [分支名稱]:[文件路徑] > [當前分支路徑]

<!-- 直接檢出其它分支文件 -->
$ git checkout [分支名稱] [文件路徑]
```

## 暫存變更 (stash)
git stash常用操作：

```html
<!-- 暫存檔前工作區修改的內容，使工作區clear，同時創建一個stash -->
$ git stash

<!-- 列出當前存在的所有暫存內容，stash通常以 stash@{0},stash@{1},... 規則命名 -->
$ git stash list

<!-- 應用/刪除/查看 指定編號的stash -->
$ git stash apply 編號
$ git stash drop 編號
$ git stash show 編號
<!-- 查看stash時，默認僅展示stash創建的分支，可添加 -v 參數列出具體的文件修改內容 -->
$ git stash show 編號 -v

<!-- 取出最近暫存的改動，該操作等價於 apply + drop -->
$ git stash pop
```

一個Git倉庫中，所有分支共享相同的stash空間，stash的創建/移除等操作均對所有分支可見。

stash的常見應用場景：

當修改了工作區中的文件，尚未提交，而遠程倉庫中此文件同樣有改動時，將遠程倉庫`pull`到本地會提示文件衝突。

1. 使用`git stash`將本地修改暫存。
1. 使用`git stash`之後，工作區會恢復到最近一次提交，所有的改動都被保存，工作區重新變爲clear。
1. 再次進行`pull`操作，將遠程倉庫拉取到本地。
1. 最後運行`git stash pop`將之前暫存的改動重新應用到當前工作區。



# 遠程倉庫
Git的遠程倉庫服務基於`SSH`，因此遠程倉庫的主機上必須安裝並啓動了**SSH服務**。
遠程倉庫的地址需要符合SSH地址的規範，即寫成`ssh://用戶名@ip地址/絕對路徑`的形式。

## 拷貝遠程倉庫
使用SSH協議複製目標主機的指定倉庫：

```
$ git clone [SSH地址]
```

## 管理遠程倉庫
使用`git remote`相關指令可以進行遠程倉庫的相關操作。

遠程倉庫的地址需要是一個有效的`URL`，創建遠程倉庫：

```
$ git remote add [遠程倉庫名] [遠程倉庫地址]
```

例如，執行指令`git remote add NetRepo ssh://root@192.168.1.199/root/Notes`，
即創建了一個目標主機地址爲`192.168.1.199`、用戶爲`root`、倉庫地址爲目標主機的`/root/CodeNotes`目錄的遠程倉庫。

其它遠程倉庫操作指令：

```c
// 列出所有的遠程倉庫
$ git remote

// 查看某個遠程倉庫的具體信息
$ git remote show [遠程倉庫名稱]

// 重命名遠程倉庫
$ git remote rename [舊倉庫名稱] [新倉庫名稱]

// 刪除遠程倉庫
$ git remote remove [遠程倉庫名稱]
```

## 管理遠程分支
使用`git push/pull`指令進行遠程分支的同步相關操作。

使用`git push`推送本地分支。
在執行推送操作之前，需要保證本地分支與遠程分支**無衝突**，否則會推送失敗。
推送一個本地分支到遠程倉庫的指定遠程分支上：

```
$ git push [遠程倉庫名] [本地分支名稱]:[遠程分支名稱]
```

當本地分支與遠程分支存在差異時，需要先使用`git pull`指令合併遠程分支，之後再進行推送操作。
接收遠程分支更新並進行合併：

```
$ git pull [遠程倉庫名] [遠程分支名稱]
```

若本地倉庫與遠程倉庫存在**同名分支**，則可以簡寫爲：

```
$ git push [遠程倉庫名] [同名分支]
```

### 分支合併規則
默認Git會將遠程倉庫推送的分支與本地倉庫的同名分支進行合併。

`git pull`實際相當於兩次操作：

1. `$ git fetch [遠程倉庫名]`
1. `$ git merge [遠程倉庫名/分支名稱]`

在特定情況下可以簡化同步命令參數。
若設置了追蹤關係，則可以省略遠程分支名：

```
$ git pull [遠程倉庫名]
```

若存在唯一的追蹤關係，則可以省略所有參數：

```
$ git pull
```

追蹤關係可以手動設定：

```html
<!-- 舊語法，存在歧異，已被廢棄 -->
$ git branch --set-upstream [本地分支] [遠程倉庫名/遠程分支名]

<!-- 新語法 -->
$ git branch -u [遠程倉庫名/遠程分支名] [本地分支]
$ git branch --set-upstream-to [遠程倉庫名/遠程分支名] [本地分支]
```

### 創建/刪除遠程分支
推送本地分支到一個不存在的遠程分支上，會在遠程倉庫上創建該分支：

```
$ git push [遠程倉庫名] [本地分支名稱]:[要創建的遠程分支名稱]
```

若推送**空本地分支**給對應遠程倉庫的指定分支，則會刪除遠程倉庫的指定分支：

```
$ git push [遠程倉庫名] :[遠程分支名稱]
```

在`Git 1.7`之後提供了刪除遠程分支的參數，作用相同：

```
$ git push [遠程倉庫名] --delete [遠程分支名稱]
```

### 強制覆蓋遠程分支內容
強制覆蓋分支的內容需要修改遠程倉庫中的`receive`配置：

```
$ git config receive.denyCurrentBranch ignore
```

同時，本機在執行`push`操作時使用`--force`參數：

```
$ git push [遠程倉庫名] [同名分支] --force
$ git push [遠程倉庫名] [本地分支名稱]:[遠程分支名稱] --force
```

若未使用`--force`參數，分支內容合併有衝突時依舊會拒絕合併而非強制覆蓋。



# GitHub 配置
`GitHub`是一個當下流行的提供免費`Git`倉庫託管服務的網站。本地的`Git`倉庫可以方便地託管到`GitHub`上。

## 創建 GitHub 倉庫
註冊完`GitHub`帳號之後，在`Repositories`頁面中即可創建`GitHub`個人倉庫。

## 生成 SSH 本地密鑰
`GitHub`支持多種傳輸協議，若使用`SSH`協議，則需要在本地生成SSH的**公鑰**和**私鑰**。

使用`ssh-keygen`命令生成密鑰：

```
$ ssh-keygen -t rsa -C [GitHub郵箱名稱]
```

生成密鑰的過程中會有選項，全部回車默認即可。
命令執行結束之後會在本地家目錄下的`.ssh`文件夾下生成兩個密鑰文件：`id_rsa`和`id_rsa.pub`。

將公鑰`id_rsa.pub`中的內容複製到`GitHub`個人設置中的`SSH keys`頁面中。
私鑰存放在需要進行提交操作的主機上(執行提交操作的主機不需要公鑰)。

`id_rsa`以及`id_rsa.pub`文件的權限必須設置爲**僅當前用戶可見**(`600`)。
若密鑰文件其他用戶、用戶組可見則無法完成同步操作。

只有使用`SSH`協議時需要設置密鑰，若使用`HTTP`協議則不需要。
使用`HTTP`協議推送時會要求輸入密碼以確認提交者身份。

## 推送本地分支
推送本地分支到遠程倉庫，執行以下步驟：

1. 在本地添加遠程GitHub倉庫地址：

	添加完密鑰之後，查看已創建的倉庫的地址，將此地址添加到遠程倉庫中。
	例如，以`GitHub`作爲遠程倉庫的名稱，當前倉庫爲地址，即輸入指令：

	```
	$ git remote add GitHub git@github.com:dainslef/Notes.git
	```

1. 遠程倉庫添加完畢後，即可使用`git push`指令推送本地分支到GitHub倉庫中。

## 關於提交者
本地`.gitconfig`文件中的郵箱最好設置成與**GitHub賬戶**郵箱相同，否則頭像等信息不會在`GitHub`的提交界面顯示出來。

只有本地提交郵箱與**GitHub賬戶**設置的郵箱相同時，纔會被認爲是當前賬戶的操作。



# 清理提交
使用`git reset --hard`強制恢復到某個提交後，在該提交之後的提交記錄並不會被刪除，
使用`git reflog`指令依然能夠看到之後`commit id`，但這些提交不在與當前分支關聯。

經常性使用`git reset --hard`變更提交記錄，會在倉庫中生成大量未與分支關聯的提交記錄，會佔用不必要的磁盤空間。

清理所有位於分支關聯的提交記錄，執行以下步驟：

1. 清除分支變更歷史。

	```
	$ git reflog expire --expire=now --all
	```

1. 壓縮到目前爲止的歷史提交信息。

	```
	$ git gc --prune=now
	```

執行以上操作之後，使用`git reflog`指令，會發現歷史變更記錄已被清空，所有未與分支聯的提交信息都已被清理。
